<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Mapa de Densidad SameDay</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.0/dist/leaflet.css" />
    <link rel="stylesheet" href="https://librekcesar.github.io/busca_zipcodes4/leaflet-search-master/leaflet-search-master/src/leaflet-search.css" />
    
    <style>
        body { margin: 0; padding: 0; }
        #map { width: 100%; height: 900px; box-shadow: 5px 5px 5px #888; }

        #map-title {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 20px;
            font-family: Arial, sans-serif;
            font-weight: bold;
            z-index: 1000;
            border: 1px solid black;
        }

        #map-legend {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: Arial, sans-serif;
            font-size: 13px;
            line-height: 1.5em;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            width: 250px;
        }

        #legend-toggle { cursor: pointer; margin-bottom: 5px; font-weight: bold; }
        #toggle-icon { float: right; }
        .legend-circle { width: 12px; height: 12px; display: inline-block; border-radius: 50%; border: 1px solid #000; margin-right: 5px; }
    </style>
</head>
<body>

    <div id="map-title">Cobertura SameDay v97 - Densidad de Entregas</div>
    <div id="map"></div>

    <div id="map-legend">
        <div id="legend-toggle">Simbología <span id="toggle-icon">▼</span></div>
        <div id="legend-content">
            <strong>Estaciones SameDay</strong><br>
            <div><span class="legend-circle" style="background-color: #84e80d;"></span> SPMX1</div>
            <div><span class="legend-circle" style="background-color: #d8180c;"></span> SPMX14</div>
            <div><span class="legend-circle" style="background-color: #1f80c8;"></span> SPMX15</div>
            <div><span class="legend-circle" style="background-color: #085085;"></span> SPMX16</div>
            <div><span class="legend-circle" style="background-color: #099b9f;"></span> SPMX19</div>
            <div><span class="legend-circle" style="background-color: #16d8de;"></span> SPMX20</div>
            <div><span class="legend-circle" style="background-color: #6e4393;"></span> SPMX21</div>
            <div><span class="legend-circle" style="background-color: #10d38c;"></span> SPMX23</div>
            <div><span class="legend-circle" style="background-color: #9cc544;"></span> SPMX27</div>
            <div><span class="legend-circle" style="background-color: #2c3fc0;"></span> SPMX28</div>
            <div><span class="legend-circle" style="background-color: #560303;"></span> SPMX29</div>
            <div><span class="legend-circle" style="background-color: #ae1052;"></span> SPMX33</div>
            <hr>
            <strong>Densidad (Paquetes/km²)</strong><br>
            <div><span class="legend-circle" style="background-color: #900404;"></span> 0 - 1 (Baja)</div>
            <div><span class="legend-circle" style="background-color: #cb5d03;"></span> 1 - 10</div>
            <div><span class="legend-circle" style="background-color: #bea007;"></span> 10 - 25</div>
            <div><span class="legend-circle" style="background-color: #ecf019;"></span> 25 - 50</div>
            <div><span class="legend-circle" style="background-color: #92d806;"></span> 50 - 100</div>
            <div><span class="legend-circle" style="background-color: #06950f;"></span> 100 - 150</div>
            <div><span class="legend-circle" style="background-color: #036407;"></span> 150 - 256 (Alta)</div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.3.0/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/2.1.0/chroma.min.js"></script>
    <script src="https://librekcesar.github.io/busca_zipcodes4/leaflet-search-master/leaflet-search-master/src/leaflet-search.js"></script>

    <script src="poligonos_sameday_v97_copia.js"></script>
    <script src="puntos_bodegas_copia.js"></script>
    <script src="poligonos_zonas_v97_dens_simp_copia.js"></script>

    <script>
        // Inicialización del Mapa
        var map = L.map("map").setView([19.47094, -99.1792], 11);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // --- CAPA 1: PUNTOS (BODEGAS) ---
        var centroLayer = L.geoJSON(centro_ideal, {
            pointToLayer: function (feature, latlng) {
                return L.circleMarker(latlng, {
                    radius: 7, fillColor: "blue", color: "#000", weight: 2, fillOpacity: 0.9
                });
            },
            onEachFeature: function (feature, layer) {
                layer.bindPopup("<b>CD:</b> " + feature.properties.direccion);
            }
        }).addTo(map);

        // --- CAPA 2: COBERTURA POR ESTACIÓN ---
        function getColorStation(s) {
            var stations = {
                'SPMX1': '#84e80d', 'SPMX14': '#d8180c', 'SPMX15': '#1f80c8',
                'SPMX16': '#085085', 'SPMX19': '#099b9f', 'SPMX20': '#16d8de',
                'SPMX21': '#6e4393', 'SPMX23': '#10d38c', 'SPMX27': '#9cc544',
                'SPMX28': '#2c3fc0', 'SPMX29': '#560303', 'SPMX33': '#ae1052'
            };
            return stations[s] || '#gray';
        }

        var layerGroup = L.geoJSON(sameday, {
            style: function(f) {
                return { fillColor: getColorStation(f.properties.station), weight: 1, color: 'black', fillOpacity: 0.4 };
            },
            onEachFeature: function(f, l) {
                l.bindPopup("Estación: " + f.properties.station);
            }
        }).addTo(map);

        // --- CAPA 3: DENSIDAD (CLASIFICACIÓN MANUAL + BUSCADOR) ---
        
        // Función para asignar colores manuales exactos
        function getColorDensidad(d) {
            return d > 150  ? '#036407' :
                   d > 100  ? '#06950f' :
                   d > 50  ? '#92d806' :
                   d > 25   ? '#ecf019' :
                   d > 10   ? '#bea007' :
                   d > 1   ? '#cb5d03' :
                             '#900404';
        }

        // PRE-PROCESAMIENTO: Creamos la propiedad de búsqueda para el rango
        same_iso.features.forEach(function(feature) {
            var d = feature.properties.densidad;
            var label = "";
            if (d > 150) label = "Intervalo 7: 150-256";
            else if (d > 100) label = "Intervalo 6: 100-150";
            else if (d > 50) label = "Intervalo 5: 50-100";
            else if (d > 25)  label = "Intervalo 4: 25-50";
            else if (d > 10)  label = "Intervalo 3: 10-25";
            else if (d > 1)  label = "Intervalo 2: 1-10";
            else label = "Intervalo 1: 0-1";
            
            // Agregamos ambas opciones para que el usuario busque como prefiera
            feature.properties.search_key = label + " | Zona: " + feature.properties.ZONAS_P_RE;
        });

        var layerGroup2 = L.geoJSON(same_iso, {
            style: function(f) {
                return { fillColor: getColorDensidad(f.properties.densidad), weight: 1.5, color: 'white', fillOpacity: 0.7 };
            },
            onEachFeature: function(f, l) {
                l.bindPopup('<b>Estación:</b> ' + f.properties.station + 
                           '<br><b>Densidad:</b> ' + f.properties.densidad + ' paq/km²' +
                           '<br><b>Zonificación:</b> ' + f.properties.ZONAS_P_RE);
            }
        });

        // --- CONTROLES DE CAPA ---
        var overlayMaps = {
            "Centros Distribución": centroLayer,
            "Cobertura SameDay": layerGroup,
            "Densidad de entregas Parcel": layerGroup2
        };
        L.control.layers(null, overlayMaps, { collapsed: false }).addTo(map);
        layerGroup2.addTo(map); // Añadida por defecto

        // --- CONFIGURACIÓN DEL BUSCADOR ---
        
        var searchControl = new L.Control.Search({
            layer: layerGroup2,
            propertyName: 'search_key', // Atributo pre-procesado
            marker: false,
            initial: false, // Permite buscar en cualquier parte del texto
            textPlaceholder: "Busca Rango (Ej: 1-4) o Zona...",
            moveToLocation: function(latlng, title, map) {
                map.setView(latlng, 12);
            }
        });

        searchControl.on('search:locationfound', function(e) {
            e.layer.setStyle({ fillOpacity: 1, color: '#0aecdb', weight: 4 });
            if(e.layer._popup) e.layer.openPopup();
        }).on('search:collapsed', function(e) {
            layerGroup2.eachLayer(function(layer) {
                layerGroup2.resetStyle(layer);
            });
        });

        map.addControl(searchControl);

        // --- LÓGICA DE LEYENDA COLAPSABLE ---
        var legendToggle = document.getElementById('legend-toggle');
        var legendContent = document.getElementById('legend-content');
        var toggleIcon = document.getElementById('toggle-icon');
        var isCollapsed = false;

        legendToggle.addEventListener('click', function() {
            isCollapsed = !isCollapsed;
            legendContent.style.display = isCollapsed ? 'none' : 'block';
            toggleIcon.textContent = isCollapsed ? '▶' : '▼';
        });

    </script>
</body>
</html>

